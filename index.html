<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“¦ Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial; text-align: center; direction: rtl; }
    table { width: 100%; margin-top: 20px; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background-color: #f2f2f2; }
    video { width: 100%; max-width: 400px; margin: auto; }
    select, button, input[type=file] { margin-top: 10px; padding: 8px; font-size: 16px; }
    .action-btn { margin: 0 5px; }
  </style>
</head>
<body>
  <h1>ðŸ“¦ Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h1>

  <select id="cameraSelect"></select>
  <button onclick="startCamera()">ðŸ“· Ø§Ø¨Ø¯Ø£ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§</button>
  <input type="file" accept="image/*" onchange="scanFromGallery(event)">
  <div id="reader" style="width: 300px; height: 300px; margin: 20px auto;"></div>

  <h2>ðŸ“‹ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
  <table id="productsTable">
    <tr>
      <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
      <th>Ø§Ù„Ø³Ø¹Ø±</th>
      <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
  </table>

  <script>
    const html5QrCode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(devices => {
      const select = document.getElementById("cameraSelect");
      devices.forEach(device => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `ÙƒØ§Ù…ÙŠØ±Ø§ ${select.length + 1}`;
        select.appendChild(option);
      });

      const backCamera = devices.find(d => d.label.toLowerCase().includes("back"));
      if (backCamera) {
        select.value = backCamera.id;
      }
    });

    function startCamera() {
      const cameraId = document.getElementById("cameraSelect").value;
      html5QrCode.start(
        cameraId,
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          handleScannedBarcode(qrCodeMessage);
        },
        errorMessage => {}
      );
    }

    function scanFromGallery(event) {
      const file = event.target.files[0];
      if (!file) return;

      html5QrCode.scanFile(file, true)
        .then(qrCodeMessage => {
          handleScannedBarcode(qrCodeMessage);
        })
        .catch(err => {
          alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„ØµÙˆØ±Ø©.");
          console.error(err);
        });
    }

    function handleScannedBarcode(code) {
      const products = JSON.parse(localStorage.getItem("products") || "{}");

      if (products[code]) {
        updateTableRow(code, products[code].name, products[code].price);
        alert(`ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬: ${products[code].name}`);
      } else {
        const name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:");
        const price = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø±:");
        if (name && price) {
          products[code] = { name, price };
          localStorage.setItem("products", JSON.stringify(products));
          addToTable(code, name, price);
        }
      }
    }

    function addToTable(barcode, name, price) {
      if (document.getElementById("row-" + barcode)) return;

      const table = document.getElementById("productsTable");
      const row = table.insertRow(-1);
      row.id = "row-" + barcode;
      row.insertCell(0).innerText = barcode;
      row.insertCell(1).innerText = name;
      row.insertCell(2).innerText = price;
      const actions = row.insertCell(3);

      const editBtn = document.createElement("button");
      editBtn.textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„";
      editBtn.className = "action-btn";
      editBtn.onclick = () => editProduct(barcode);

      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "ðŸ—‘ï¸ Ø­Ø°Ù";
      deleteBtn.className = "action-btn";
      deleteBtn.onclick = () => removeProduct(barcode);

      actions.appendChild(editBtn);
      actions.appendChild(deleteBtn);
    }

    function updateTableRow(barcode, name, price) {
      const row = document.getElementById("row-" + barcode);
      if (row) {
        row.cells[1].innerText = name;
        row.cells[2].innerText = price;
      }
    }

    function editProduct(barcode) {
      const products = JSON.parse(localStorage.getItem("products") || "{}");
      const current = products[barcode];
      const newName = prompt("Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯:", current.name);
      const newPrice = prompt("Ø³Ø¹Ø± Ø¬Ø¯ÙŠØ¯:", current.price);

      if (newName && newPrice) {
        products[barcode] = { name: newName, price: newPrice };
        localStorage.setItem("products", JSON.stringify(products));
        updateTableRow(barcode, newName, newPrice);
      }
    }

    function removeProduct(barcode) {
      const row = document.getElementById("row-" + barcode);
      if (row) row.remove();

      const products = JSON.parse(localStorage.getItem("products") || "{}");
      delete products[barcode];
      localStorage.setItem("products", JSON.stringify(products));
    }

    window.onload = function () {
      const products = JSON.parse(localStorage.getItem("products") || "{}");
      for (const [code, info] of Object.entries(products)) {
        addToTable(code, info.name, info.price);
      }
    };
  </script>
</body>
</html>
