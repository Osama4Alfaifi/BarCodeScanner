<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ðŸ“· Ù‚Ø§Ø±Ø¦ Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</title>
  <script src="https://unpkg.com/html5-qrcode"></script>
  <style>
    body { font-family: Arial; text-align: center; direction: rtl; }
    #reader { width: 300px; height: 300px; margin: 20px auto; border: 1px solid #ccc; }
    button, select, input[type=file] { padding: 10px; font-size: 16px; margin: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background-color: #f2f2f2; }
    .action-btn { margin: 0 4px; }
  </style>
</head>
<body>
  <h1>ðŸ“¦ Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</h1>
  <select id="cameraSelect"></select>
  <button onclick="startScanner()">ðŸ“· Ø§Ø¨Ø¯Ø£ Ø§Ù„Ù…Ø³Ø­</button>
  <input type="file" accept="image/*" onchange="scanFromGallery(event)">
  <div id="reader"></div>

  <table id="productsTable" style="margin-top: 60px;">
    <tr>
      <th>Ø§Ù„Ø¨Ø§Ø±ÙƒÙˆØ¯</th>
      <th>Ø§Ù„Ø§Ø³Ù…</th>
      <th>Ø§Ù„Ø³Ø¹Ø±</th><th>Ø§Ù„ØµÙˆØ±Ø©</th>
      <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
    </tr>
  </table>

  <script>
    let html5QrCode = new Html5Qrcode("reader");

    Html5Qrcode.getCameras().then(devices => {
      const select = document.getElementById("cameraSelect");
      devices.forEach(device => {
        const option = document.createElement("option");
        option.value = device.id;
        option.text = device.label || `ÙƒØ§Ù…ÙŠØ±Ø§ ${select.length + 1}`;
        select.appendChild(option);
      });
      const back = devices.find(d => d.label.toLowerCase().includes("back"));
      if (back) select.value = back.id;
    });

    function startScanner() {
      const camId = document.getElementById("cameraSelect").value;
      html5QrCode.start(
        camId,
        { fps: 10, qrbox: 250 },
        qrCodeMessage => {
          handleScan(qrCodeMessage);
        },
        error => {}
      );
    }

    function scanFromGallery(event) {
      const file = event.target.files[0];
      if (!file) return;

      html5QrCode.stop().then(() => {
        return html5QrCode.scanFile(file, true);
      }).then(qrCodeMessage => {
        handleScan(qrCodeMessage);
      }).catch(err => {
        alert("ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„ØµÙˆØ±Ø©");
        console.error(err);
      });
    }

    
    function handleScan(code) {
      const products = JSON.parse(localStorage.getItem("products") || "{}");

      if (products[code]) {
        alert("Ø§Ù„Ù…Ù†ØªØ¬ Ù…ÙˆØ¬ÙˆØ¯: " + products[code].name);
        updateRow(code, products[code].name, products[code].price, products[code].image || "");
      } else {
        const name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:");
        const price = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø±:");
        if (name && price) {

        const imageInput = document.createElement("input");
        imageInput.type = "file";
        imageInput.accept = "image/*";
        imageInput.style.display = "none";
        document.body.appendChild(imageInput);
        imageInput.click();

        imageInput.onchange = () => {
          const file = imageInput.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
              products[code] = { name, price, image: e.target.result };
              localStorage.setItem("products", JSON.stringify(products));
              addRow(code, name, price, e.target.result);
              imageInput.remove();
            };
            reader.readAsDataURL(file);
          } else {
            products[code] = { name, price, image: "" };
            localStorage.setItem("products", JSON.stringify(products));
            addRow(code, name, price, "");
            imageInput.remove();
          }
        };

        }
      }
    }
 else {
        const name = prompt("Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬:");
        const price = prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ø³Ø¹Ø±:");
        if (name && price) {
          products[code] = { name, price };
          localStorage.setItem("products", JSON.stringify(products));
          addRow(code, name, price);
        }
      }
    }

    function addRow(barcode, name, price, image) {
      if (document.getElementById("row-" + barcode)) return;

      const table = document.getElementById("productsTable");
      const row = table.insertRow(-1);
      row.id = "row-" + barcode;
      row.insertCell(0).innerText = barcode;
      row.insertCell(1).innerText = name;
      row.insertCell(2).innerText = price;
      const imgCell = row.insertCell(3);
      if (image) {
        const img = document.createElement("img");
        img.src = image;
        img.style.width = "50px";
        img.style.height = "50px";
        imgCell.appendChild(img);
      } else {
        imgCell.innerText = "â€”";
      }
      const actions = row.insertCell(3);

      const editBtn = document.createElement("button");
      editBtn.className = "action-btn";
      editBtn.innerText = "âœï¸ ØªØ¹Ø¯ÙŠÙ„";
      editBtn.onclick = () => editProduct(barcode);

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "action-btn";
      deleteBtn.innerText = "ðŸ—‘ï¸ Ø­Ø°Ù";
      deleteBtn.onclick = () => deleteProduct(barcode);

      actions.appendChild(editBtn);
      actions.appendChild(deleteBtn);
    }

    function updateRow(barcode, name, price, image) {
      const row = document.getElementById("row-" + barcode);
      if (row) {
        row.cells[1].innerText = name;
        row.cells[2].innerText = price;
      } else {
        addRow(barcode, name, price);
      }
    }

    function editProduct(barcode) {
      const products = JSON.parse(localStorage.getItem("products") || "{}");
      const product = products[barcode];
      const newName = prompt("Ø§Ø³Ù… Ø¬Ø¯ÙŠØ¯:", product.name);
      const newPrice = prompt("Ø³Ø¹Ø± Ø¬Ø¯ÙŠØ¯:", product.price);

      if (newName && newPrice) {
        products[barcode] = { name: newName, price: newPrice };
        localStorage.setItem("products", JSON.stringify(products));
        updateRow(barcode, newName, newPrice, products[barcode].image || "");
      }
    }

    function deleteProduct(barcode) {
      const row = document.getElementById("row-" + barcode);
      if (row) row.remove();

      const products = JSON.parse(localStorage.getItem("products") || "{}");
      delete products[barcode];
      localStorage.setItem("products", JSON.stringify(products));
    }

    
    function filterTable() {
      const input = document.getElementById("searchInput").value.toLowerCase();
      const rows = document.querySelectorAll("#productsTable tr:not(:first-child)");
      rows.forEach(row => {
        const nameCell = row.cells[1];
        if (nameCell) {
          const name = nameCell.innerText.toLowerCase();
          row.style.display = name.includes(input) ? "" : "none";
        }
      });
    }

    window.onload = () => {
    
      const products = JSON.parse(localStorage.getItem("products") || "{}");
      for (const [barcode, data] of Object.entries(products)) {
        addRow(barcode, data.name, data.price, data.image || "");
      }
    };
  </script>
</body>
</html>
